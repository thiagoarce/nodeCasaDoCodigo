"use strict";

var GlobalComponentsContext = require("./GlobalComponentsContext");

function ComponentsContext(out, parentComponentsContext) {
    var globalComponentsContext;
    var componentDef;

    if (parentComponentsContext) {
        globalComponentsContext = parentComponentsContext.m_;
        componentDef = parentComponentsContext.j_;

        var nestedContextsForParent;
        if (!(nestedContextsForParent = parentComponentsContext._M_)) {
            nestedContextsForParent = parentComponentsContext._M_ = [];
        }

        nestedContextsForParent.push(this);
    } else {
        globalComponentsContext = out.global.i_;
        if (globalComponentsContext === undefined) {
            out.global.i_ = globalComponentsContext = new GlobalComponentsContext(out);
        }
    }

    this.m_ = globalComponentsContext;
    this.i_ = [];
    this.A_ = out;
    this.j_ = componentDef;
    this._M_ = undefined;
}

ComponentsContext.prototype = {
    B_: function (doc) {
        var componentDefs = this.i_;

        ComponentsContext._N_(componentDefs, doc);

        this.A_.emit("_O_");

        // Reset things stored in global since global is retained for
        // future renders
        this.A_.global.i_ = undefined;

        return componentDefs;
    }
};

function getComponentsContext(out) {
    return out.i_ || (out.i_ = new ComponentsContext(out));
}

module.exports = exports = ComponentsContext;

exports.E_ = getComponentsContext;