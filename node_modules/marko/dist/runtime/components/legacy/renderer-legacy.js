var getComponentsContext = require("../ComponentsContext").E_;
var componentsUtil = require("../util");
var componentLookup = componentsUtil.h_;
var registry = require("../registry");
var modernRenderer = require("../renderer");
var resolveComponentKey = modernRenderer.al_;
var trackAsyncComponents = modernRenderer.aw_;
var beginComponent = require("../beginComponent");
var endComponent = require("../endComponent");
var w10NOOP = require("warp10/constants").NOOP;

function createRendererFunc(templateRenderFunc, componentProps) {
    var typeName = componentProps.f_;
    //var assignedId = componentProps.id;
    var isSplit = componentProps.d_ === true;

    return function renderer(input, out, assignedId, renderingLogic) {
        trackAsyncComponents(out);

        var widgetBody = input.renderBody;
        var widgetState = input.widgetState;
        var widgetConfig = input.widgetConfig;

        var componentsContext = getComponentsContext(out);
        var globalComponentsContext = componentsContext.m_;

        var component = globalComponentsContext._r_;

        var isRerender = component !== undefined;
        var id = assignedId;
        var isExisting;
        var parentComponentDef = componentsContext.j_;
        var ownerComponentDef = out.l_;
        var ownerComponentId = ownerComponentDef && ownerComponentDef.id;
        var key = out.ao_;
        var customEvents = out.ax_;

        out.l_ = null;

        if (component) {
            id = component.id;
            isExisting = true;
            globalComponentsContext._r_ = null;
        } else {
            if (key != null) {
                id = id || resolveComponentKey(key.toString(), parentComponentDef);
            } else if (parentComponentDef) {
                id = parentComponentDef._I_();
            } else {
                id = globalComponentsContext._I_();
            }
        }

        if (registry.ay_ && typeName) {
            if (renderingLogic) delete renderingLogic.onRender;
            component = registry._K_(renderingLogic || {}, id, input, out, typeName, customEvents, ownerComponentId);
            if (input.widgetProps) {
                component.input = input.widgetProps;
            }
        } else {
            if (!component) {
                if (isRerender) {
                    // Look in in the DOM to see if a component with the same ID and type already exists.
                    component = componentLookup[id];
                    if (component && component.f_ !== typeName) {
                        component = undefined;
                    }
                }

                if (component) {
                    isExisting = true;
                } else {
                    isExisting = false;
                    // We need to create a new instance of the component
                    if (typeName) {
                        component = registry._K_(typeName, id);
                    }
                }
            }
        }

        var isFakeComponent = false;

        if (!component) {
            isFakeComponent = true;
            component = {
                id: id,
                n_: {}
            };
        } else {
            component.V_ = true;
        }

        component.state = widgetState;
        component.widgetConfig = widgetConfig;
        component.ap_ = widgetBody || component.ap_ || w10NOOP;

        var componentDef = beginComponent(componentsContext, component, key, ownerComponentDef, isSplit, isFakeComponent);
        var parentLegacyComponentDef = componentsContext.av_;
        componentsContext.av_ = componentDef;

        // This is a hack, but we have to swap out the component instance stored with this node
        var vComponentNode = out.az_;

        componentDef.k_ = isFakeComponent ? null : component;
        componentDef._D_ = isExisting;
        componentDef.ah_ = true;

        componentDef.t = function (typeName) {
            if (typeName) {
                if (registry.ay_) {
                    var oldComponent = component;
                    if (renderingLogic) delete renderingLogic.onRender;
                    component = registry._K_(renderingLogic || {}, id, input, out, typeName, customEvents, ownerComponentId);
                    if (input.widgetProps) {
                        component.input = input.widgetProps;
                    }
                    Object.assign(component, oldComponent);
                    beginComponent(componentsContext, component, key, ownerComponentDef, isSplit, false, this);
                } else {
                    vComponentNode.k_ = component = registry._K_(typeName, component.id);
                }
                this.k_ = component;
            }
        };

        if (!isFakeComponent && !registry.ay_) {
            component.F_("ar_");
        }

        // Render the template associated with the component using the final template
        // data that we constructed
        templateRenderFunc(input, out, componentDef, componentDef, component);

        if (customEvents && componentDef.k_) {
            if (registry.ay_) {
                componentDef.P_ = customEvents;
                componentDef.I_ = ownerComponentId;
            } else {
                componentDef.k_._w_(customEvents, ownerComponentId);
            }
        }

        endComponent(out, componentDef);
        componentsContext.j_ = parentComponentDef;
        componentsContext.av_ = parentLegacyComponentDef;
    };
}

module.exports = createRendererFunc;